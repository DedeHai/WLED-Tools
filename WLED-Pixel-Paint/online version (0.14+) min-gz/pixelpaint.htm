<!doctypehtml><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1"><meta name=author content=@dedehai><meta name=license content="EUPL v. 1.2 or later"><title>WLED Pixel Paint</title><script src=https://cdn.jsdelivr.net/npm/@jaames/iro@5.5.2/dist/iro.min.js></script><script src=https://cdn.jsdelivr.net/npm/omggif@1.0.10/omggif.js></script><style>@font-face{font-family:painter;src:url('data:font/woff2;charset=utf-8;base64,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') format('woff2')}html{touch-action:manipulation}body{font-family:Verdana,sans-serif;font-size:1rem;text-align:center;background:#222;color:#fff;line-height:200%;margin:0 auto;padding:8px;max-width:900px;box-sizing:border-box}body.mode-1d{max-width:none}*,::after,::before{box-sizing:border-box}.btn,button{background:#333;color:#fff;font-family:Verdana,sans-serif;border:.3ch solid #333;border-radius:24px;font-size:20px;margin:2px 2px;padding:8px 12px;min-width:48px;cursor:pointer;transition:all .3s ease}.btn:hover,button:hover{background:#555;border-color:#555}button:disabled{background:#222;color:#666;cursor:not-allowed}input,select{background:#333;color:#fff;font-family:Verdana,sans-serif;border:.5ch solid #333;font-size:medium;margin:2px}input[type=number]{width:5em}.title{font-size:28px;font-weight:700;padding:12px 0;margin-bottom:12px}.title .rb{font-size:32px;font-weight:700;background:repeating-linear-gradient(90deg,#ff6b6b 0 6px,#feca57 6px 12px,#48dbfb 12px 18px,#7b47db 18px 24px);background-size:24px 24px;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:pixshift 8s steps(15) infinite}@keyframes pixshift{to{background-position:24px 24px}}.matrix-controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;align-items:center}.matrix-controls .size-inputs{display:flex;align-items:center;gap:6px}.matrix-controls button{margin:0;padding:6px 12px;font-size:16px;min-width:40px}.main-content{display:flex;flex-direction:column;align-items:center;gap:16px}.controls-section{display:flex;justify-content:center;align-items:stretch;gap:12px;padding:0 4px}#iroPicker{flex-shrink:1;min-width:200}.tools-container{display:flex;flex-direction:column;flex-shrink:1;min-width:0}.tools{display:grid;grid-template-columns:repeat(2,1fr);gap:3px;flex:1;align-content:start}.tool-btn{font-family:painter;aspect-ratio:1;background:#333;border:2px solid #666;border-radius:14px;align-items:center;justify-content:center;cursor:pointer;font-size:18px;padding:0}.tool-btn.selected{background:#08d;color:#fff;border-color:#08d}body.mode-1d #matrixH,body.mode-1d .size-sep,body.mode-1d .tool-btn.hide-1d{display:none}body.mode-1d .led-count-1d{display:inline!important}.sliders{display:flex;flex-direction:column;gap:10px;width:100%;max-width:600px;padding:0 4px;margin:0 auto 16px}.slider-row{display:flex;align-items:center;gap:8px}.slider-row .slider{flex:1;accent-color:#08d;height:6px;min-width:60px}.slider-row label{font-size:13px;white-space:nowrap;min-width:50px;order:3}.slider-row .value{font-size:13px;min-width:30px;text-align:right;font-weight:700;color:#08d;order:2}.canvas-container{width:100%;max-width:600px;margin:0 auto 16px;padding:0 4px;display:flex;flex-direction:column;align-items:center;gap:12px}body.mode-1d .canvas-container{max-width:none}.prev-1d-container{width:100%;display:none}.prev-1d-container.visible{display:block}.prev-1d-label{font-size:14px;color:#aaa;margin-bottom:4px}body.mode-1d #prev1DCont{position:sticky;top:0;z-index:20;background:#222}#canvPrev1D{border:2px solid #08d;background:#111;width:100%;height:40px;touch-action:none;image-rendering:pixelated}.wrapped-rows-container{width:100%;display:none;flex-direction:column;gap:20px}.wrapped-rows-container.visible{display:flex}.row-canvas-wrapper{width:100%;cursor:pointer}.row-canvas-wrapper canvas{border:1px solid #666;background:#111;touch-action:none;image-rendering:pixelated;display:block}#canv{border:2px solid #fff;background:#111;max-width:100%;max-height:60vh;width:auto;height:auto;touch-action:none}#canv.hidden{display:none}.tools-wrapper{display:flex;flex-direction:column;gap:16px}#status{padding:6px 16px;border-radius:20px;background:#a00;font-size:14px}.upload-section{margin:20px 0;padding:0 4px}.filename-input{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;align-items:center;margin-bottom:12px}.filename-input input[type=text]{max-width:200px;padding:6px 10px}@media (min-aspect-ratio:4/3) and (min-width:600px){body:not(.mode-1d) .main-content{flex-direction:row;align-items:flex-start;justify-content:center;gap:16px}body:not(.mode-1d) .canvas-container{order:2;margin:0;max-width:none;flex:1;min-width:0;padding:0}#canv{max-height:85vh}body:not(.mode-1d) .tools-wrapper{order:1;width:300px;flex-shrink:0}body:not(.mode-1d) .controls-section{flex-direction:row;align-items:center;margin-bottom:16px}body:not(.mode-1d) .sliders{max-width:none;margin:0}.tool-btn{font-size:20px}.tools{row-gap:4px;column-gap:8px}}@media (pointer:coarse){body.mode-1d .row-canvas-wrapper canvas{height:40px!important}body.mode-1d #canvPrev1D{height:50px!important}}</style><div style=position:absolute;top:0;left:10px;font-size:10px;color:#666>v1.1</div><div class=title>WLED<span class=rb>PIXEL</span>Paint</div><div class=matrix-controls><h3>Target Segment</h3><select id=seg><option value=0 data-w=16 data-h=16>Segment 0 (16x16)</select><div class=size-inputs><span class=led-count-1d style=display:none>LEDs:</span><input type=number id=matrixW value=64><span class=size-sep>√ó</span><input type=number id=matrixH value=64></div><div><button onclick=togglePreview() title="Live Preview"id=status>Preview Off</button></div><div><input type=checkbox id=frz checked> Freeze Segment</div></div><div style=margin-top:16px;margin-bottom:16px><button onclick=openImage() title="Open Image"class="tool-btn action"><span>ÔÅº</span></button><input type=file id=imgFile accept=image/* style=display:none><button onclick=clearMatrix() title=Clear class=tool-btn><span>ÔÄç</span></button><button onclick=undo() title=Undo class=tool-btn><span>Ó•ß</span></button><button onclick=redo() title=Redo class=tool-btn><span style=display:inline-block;transform:scaleX(-1)>Ó•ß</span></button></div><div class=main-content><div class=tools-wrapper><div class=controls-section><div id=iroPicker></div><div class=tools-container><div class=tools id=tools></div></div></div><div class=sliders><div class=slider-row><input type=range id=sizeSlider min=1 max=10 step=0.1 value=1 class=slider><span class=value id=brushSizeLabel>1.0</span><label>Size</label></div><div class=slider-row><input type=range id=hardnessSlider min=1 max=100 value=100 class=slider><span class=value id=brushHardnessLabel>100</span><label>Hard</label></div></div></div><div class=canvas-container><div class=prev-1d-container id=prev1DCont><div class=prev-1d-label>Full Strip</div><canvas id=canvPrev1D></canvas></div><div class=prev-1d-label>Detail View</div><div class=wrapped-rows-container id=wrapRowCont></div><div class=wrapped-canvas-container><canvas id=canv></canvas></div></div></div><div class=upload-section id=uploadSect><div class=upload><div class=filename-input><label for=fn>Name:</label><input id=fn placeholder=mypaint maxlength=20></div><button class=btn id=savePreset onclick=savePreset()>Save as Preset</button><button class=btn id=saveGIF onclick=saveGIF()>Save as GIF</button></div></div><div style="text-align:center;margin:20px 0"><button class=btn onclick="window.location.href=wu">Back to Controls</button></div><div style=font-size:12px;color:#666>by @dedehai</div><script>const PIXEL_SIZE=32,DEFAULT_MATRIX=64,MIN_MATRIX=1,MAX_LEDS=4096,MAX_MATRIX=128,LED_PX_SIZE=16,ROW_HEIGHT=24,TOOLS=[{name:"Line",icon:"&#xf068;"},{name:"Rect",icon:"&#xf096;"},{name:"Circle",icon:"&#xf1db;"},{name:"Fill",icon:"&#xe90b;"},{name:"Rainbow",icon:"üåà"},{name:"Brush",icon:"&#xf1fc;"},{name:"Smear",icon:"&#xf25a;"}];TOOLS.forEach(((t,e)=>{const n=document.createElement("button");n.className="tool-btn"+(5==e?" selected":"")+(e<3?" hide-1d":""),n.innerHTML=t.icon,n.title=t.name,n.onclick=()=>{document.querySelectorAll(".tool-btn").forEach((t=>t.classList.remove("selected"))),n.classList.add("selected"),tool=e},document.getElementById("tools").appendChild(n)}));const canv=document.getElementById("canv"),ctx=canv.getContext("2d"),canvPrev1D=document.getElementById("canvPrev1D"),ctxPrev1D=canvPrev1D.getContext("2d"),mW=document.getElementById("matrixW"),mH=document.getElementById("matrixH"),statusEl=document.getElementById("status"),wrapRowCont=document.getElementById("wrapRowCont"),isTouch="ontouchstart"in window||navigator.maxTouchPoints>0;let iroPicker,w=64,h=64,matrix=[],segs=[],curSeg=null,painting=!1,tool=5,startPt=null,lastPos=null,preview=null,brushSize=1,brushHard=100,hue=0,undoStack=[],redoStack=[],ws=null,prvEn=!1,maxColInd=null,prvTmr=null,lastSentMtx=[],wu="",loc=!1,snapMtx=null,is1D=!1,wrapW=50,rowCanv=[],selRow=0,offCanv=document.createElement("canvas"),offCtx=offCanv.getContext("2d"),globalBri=null;const c2h=(t,e,n)=>(t<<16|e<<8|n).toString(16).padStart(6,"0").toUpperCase();function updateMatrix(){is1D=+mH.value<=1,is1D?(w=Math.max(MIN_MATRIX,Math.min(MAX_LEDS,+mW.value)),h=1,document.body.classList.add("mode-1d"),mW.disabled=!0,mH.disabled=!0,document.getElementById("prev1DCont").classList.add("visible"),document.querySelectorAll(".prev-1d-label").forEach((t=>t.style.display="block")),wrapRowCont.classList.add("visible"),canv.classList.add("hidden"),canvPrev1D.width=w,canvPrev1D.height=1,offCanv.width=w,offCanv.height=1,createRowCanv()):(w=Math.max(MIN_MATRIX,Math.min(MAX_MATRIX,+mW.value)),h=Math.max(1,Math.min(MAX_MATRIX,+mH.value)),mW.value=w,mH.value=h,document.body.classList.remove("mode-1d"),mW.disabled=!1,mH.disabled=!1,document.getElementById("prev1DCont").classList.remove("visible"),document.querySelectorAll(".prev-1d-label").forEach((t=>t.style.display="none")),wrapRowCont.classList.remove("visible"),canv.classList.remove("hidden"),offCanv.width=w,offCanv.height=h),canv.width=w*PIXEL_SIZE,canv.height=h*PIXEL_SIZE,canv.style.aspectRatio=`${w}/${h}`;const t=w*h;matrix.length!=t&&(matrix=Array.from({length:t},(()=>({r:0,g:0,b:0})))),drawAll()}function createRowCanv(){wrapRowCont.innerHTML="",rowCanv=[];const t=(wrapRowCont.offsetWidth||800)-(isTouch?48:0),e=Math.floor(t/LED_PX_SIZE);wrapW=Math.max(10,Math.min(200,e));const n=Math.ceil(mW.value/wrapW);for(let t=0;t<n;t++){const e=t*wrapW,n=Math.min(e+wrapW,mW.value),a=n-e,o=document.createElement("div");o.className="row-canvas-wrapper",o.style.position="relative",0===t&&o.classList.add("selected");const r=document.createElement("div");r.style.cssText="font-size:10px;color:#999;display:flex;justify-content:space-between;padding:0 2px;position:absolute;top:-24px;left:0;right:0;pointer-events:none;width:"+a*LED_PX_SIZE+"px;",r.innerHTML=`<span>${e}</span><span>${n-1}</span>`,o.appendChild(r);const i=document.createElement("canvas");i.width=a*LED_PX_SIZE,i.height=LED_PX_SIZE,i.style.width=a*LED_PX_SIZE+"px",i.style.height=ROW_HEIGHT+"px";const s=i.getContext("2d");s.imageSmoothingEnabled=!1,i.onpointerdown=e=>{selRow=t,rowCanv.forEach(((e,n)=>e.wrap.classList.toggle("selected",n===t))),startPaint(e,"row")},i.onpointermove=e=>{e.preventDefault(),painting&&selRow===t&&paint(e,"row")},i.onpointerleave=()=>{preview=lastPos=null,drawAll()},o.appendChild(i),wrapRowCont.appendChild(o),rowCanv.push({canv:i,ctx:s,si:e,ei:n,wrap:o})}selRow=0,drawAll()}let resizeTmr;function getCoord(t,e){if("1d"===e){const e=canvPrev1D.getBoundingClientRect(),n=canvPrev1D.width/e.width,a=Math.floor((t.clientX-e.left)*n);return{idx:Math.max(0,Math.min(mW.value-1,a))}}if("row"===e){const e=rowCanv[selRow],n=e.canv.getBoundingClientRect(),a=t.clientX-n.left,o=e.ei-e.si,r=Math.floor(a/n.width*o);return{idx:e.si+Math.max(0,Math.min(o-1,r))}}const n=canv.getBoundingClientRect(),a=canv.width/n.width,o=canv.height/n.height;return{x:Math.floor((t.clientX-n.left)*a/PIXEL_SIZE),y:Math.floor((t.clientY-n.top)*o/PIXEL_SIZE)}}function drawAll(){if(is1D){offCtx.fillStyle="#111",offCtx.fillRect(0,0,w,1);for(let t=0;t<w;t++){const e=matrix[t];offCtx.fillStyle=`rgb(${e.r},${e.g},${e.b})`,offCtx.fillRect(t,0,1,1)}return ctxPrev1D.imageSmoothingEnabled=!1,ctxPrev1D.drawImage(offCanv,0,0,canvPrev1D.width,canvPrev1D.height),void rowCanv.forEach((t=>{const e=t.ctx,n=t.canv;e.fillStyle="#111",e.fillRect(0,0,n.width,n.height);for(let a=t.si;a<t.ei;a++){const o=matrix[a];e.fillStyle=`rgb(${o.r},${o.g},${o.b})`,e.fillRect((a-t.si)*LED_PX_SIZE,0,LED_PX_SIZE,n.height)}e.strokeStyle="#666",e.lineWidth=1,e.beginPath();for(let a=1;a<t.ei-t.si;a++){const t=a*LED_PX_SIZE;e.moveTo(t,0),e.lineTo(t,n.height)}e.stroke()}))}offCtx.fillStyle="#111",offCtx.fillRect(0,0,w,h);const t=offCtx.createImageData(w,h),e=t.data;for(let t=0;t<w*h;t++){const n=matrix[t],a=4*t;e[a]=n.r,e[a+1]=n.g,e[a+2]=n.b,e[a+3]=255}if(offCtx.putImageData(t,0,0),ctx.imageSmoothingEnabled=!1,ctx.drawImage(offCanv,0,0,canv.width,canv.height),preview){ctx.strokeStyle="rgba(255,255,255,0.8)",ctx.lineWidth=Math.max(1,brushSize*PIXEL_SIZE/4);const t=preview.start.x*PIXEL_SIZE+PIXEL_SIZE/2,e=preview.start.y*PIXEL_SIZE+PIXEL_SIZE/2,n=preview.end.x*PIXEL_SIZE+PIXEL_SIZE/2,a=preview.end.y*PIXEL_SIZE+PIXEL_SIZE/2;if(ctx.beginPath(),0===preview.tool)ctx.moveTo(t,e),ctx.lineTo(n,a);else if(1===preview.tool){const o=Math.min(t,n),r=Math.min(e,a);ctx.rect(o,r,Math.max(t,n)-o,Math.max(e,a)-r)}else 2===preview.tool&&ctx.ellipse((t+n)/2,(e+a)/2,Math.abs(n-t)/2,Math.abs(a-e)/2,0,0,2*Math.PI);ctx.stroke()}ctx.strokeStyle="rgba(255,255,255,0.15)",ctx.lineWidth=1,ctx.beginPath();for(let t=1;t<w;t++){const e=t*PIXEL_SIZE;ctx.moveTo(e,0),ctx.lineTo(e,canv.height)}for(let t=1;t<h;t++){const e=t*PIXEL_SIZE;ctx.moveTo(0,e),ctx.lineTo(canv.width,e)}ctx.stroke()}function setPx(t,e,n,a=1,o=!0){if(t<0||t>=w||e<0||e>=h)return;const r=e*w+t,i=matrix[r];matrix[r]={r:Math.round((1-a)*i.r+a*n.r),g:Math.round((1-a)*i.g+a*n.g),b:Math.round((1-a)*i.b+a*n.b)},o&&drawAll()}function getPx(t,e){return matrix[Math.max(0,Math.min(h-1,e))*w+Math.max(0,Math.min(w-1,t))]}function colorDist(t,e){const n=t.r-e.r,a=t.g-e.g,o=t.b-e.b;return Math.sqrt(n*n+a*a+o*o)}function saveState(){undoStack.push(matrix.map((t=>({r:t.r,g:t.g,b:t.b})))),undoStack.length>50&&undoStack.shift(),redoStack=[]}function undo(){undoStack.length&&(redoStack.push(matrix.map((t=>({r:t.r,g:t.g,b:t.b})))),matrix=undoStack.pop(),drawAll(),prvEn&&sendDirty())}function redo(){redoStack.length&&(undoStack.push(matrix.map((t=>({r:t.r,g:t.g,b:t.b})))),matrix=redoStack.pop(),drawAll(),prvEn&&sendDirty())}function applyBrush(t,e,n,a,o){if(o){let t=iro.Color.rgbToHsv(n);hue+=1/brushSize,t.h=hue,n=iro.Color.hsvToRgb(t)}const r=Math.ceil(brushSize),i=.01*brushHard;if(is1D){const a=e*w+t;for(let t=-r;t<=r;t++){const e=Math.abs(t);if(e>brushSize)continue;const o=a+t;if(o<0||o>=mW.value)continue;const r=1-e/brushSize,s=matrix[o],l=r*i;matrix[o]={r:Math.round((1-l)*s.r+l*n.r),g:Math.round((1-l)*s.g+l*n.g),b:Math.round((1-l)*s.b+l*n.b)}}}else for(let a=-r;a<=r;a++)for(let o=-r;o<=r;o++){const r=Math.sqrt(a*a+o*o);if(r>brushSize)continue;setPx(t+a,e+o,n,(1-r/brushSize)*i,!1)}a&&drawAll()}function clearMatrix(){matrix=Array.from({length:w*h},(()=>({r:0,g:0,b:0}))),drawAll(),prvEn&&sendDirty()}async function togglePreview(){if(prvEn=!prvEn,statusEl.textContent=prvEn?"Preview On":"Preview Off",statusEl.style.background=prvEn?"#08d":"#a00",prvEn){reqJson({seg:{frz:!0}}),initWS(),lastSentMtx=new Array(w*h).fill(null);const t=+document.getElementById("seg").value;curSeg=segs.find((e=>e.id===t))||{id:t,start:0},await sendDirty()}else reqJson({seg:{frz:!1}}),prvTmr&&clearTimeout(prvTmr),prvTmr=curSeg=null}function startPaint(t,e){t.preventDefault(),painting=!0;const n=getCoord(t,e);startPt=lastPos=n,saveState(),snapMtx=matrix.map((t=>({r:t.r,g:t.g,b:t.b}))),paint(t,e),prvEn&&!prvTmr&&paintCmp()}async function endPaint(){const t=painting;painting&&preview&&!is1D&&(0===preview.tool?applyLine(preview.start.x,preview.start.y,preview.end.x,preview.end.y,iroPicker.color.rgb):1===preview.tool?applyRect(preview.start.x,preview.start.y,preview.end.x,preview.end.y,iroPicker.color.rgb):2===preview.tool&&applyCircle(preview.start.x,preview.start.y,preview.end.x,preview.end.y,iroPicker.color.rgb),preview=null,drawAll()),painting=!1,startPt=lastPos=null,t&&prvEn&&(setTimeout((async()=>{const t=[];for(let e=0;e<matrix.length;e++){const n=snapMtx[e],a=matrix[e];n.r===a.r&&n.g===a.g&&n.b===a.b||t.push({idx:e,hex:c2h(a.r,a.g,a.b)})}t.length&&await sendDirty(t)}),80),setTimeout((async()=>{await sendDirty()}),300))}function paint(t,e){const n=getCoord(t,e),a=iroPicker.color.rgb,o=void 0!==n.idx?n.idx%w:n.x,r=void 0!==n.idx?Math.floor(n.idx/w):n.y;let i=!1;switch(tool){case 0:case 1:case 2:startPt&&!is1D&&(preview={tool:tool,start:startPt,end:n},drawAll());break;case 3:floodFill(o,r,a);break;case 4:i=!0;case 5:if(lastPos){const t=void 0!==lastPos.idx?lastPos.idx%w:lastPos.x,e=void 0!==lastPos.idx?Math.floor(lastPos.idx/w):lastPos.y;if(t!==o||e!==r){const n=o-t,s=r-e,l=Math.max(1,Math.ceil(Math.sqrt(n*n+s*s)));for(let o=0;o<=l;o++)applyBrush(Math.round(t+n*o/l),Math.round(e+s*o/l),a,!1,i);drawAll()}else applyBrush(o,r,a,!0,i)}else applyBrush(o,r,a,!0,i);lastPos=n;break;case 6:if(lastPos){const t=void 0!==lastPos.idx?lastPos.idx%w:lastPos.x,e=void 0!==lastPos.idx?Math.floor(lastPos.idx/w):lastPos.y;if(t!==o||e!==r){const n=o-t,a=r-e,i=Math.max(1,Math.ceil(Math.sqrt(n*n+a*a))),s=Math.ceil(brushSize);for(let o=0;o<=i;o++){const r=Math.round(t+n*o/i),l=Math.round(e+a*o/i);for(let n=-s;n<=s;n++)for(let a=-s;a<=s;a++){const o=Math.sqrt(n*n+a*a);if(o>brushSize)continue;const i=(1-o/brushSize)*(.3+brushHard/100*.7);setPx(r+n,l+a,getPx(t+n,e+a),i,!1)}}drawAll()}}lastPos=n}}function applyLine(t,e,n,a,o){let r=Math.abs(n-t),i=Math.abs(a-e),s=t<n?1:-1,l=e<a?1:-1,c=r-i;for(;applyBrush(t,e,o,!1),t!=n||e!=a;){const n=2*c;n>-i&&(c-=i,t+=s),n<r&&(c+=r,e+=l)}drawAll()}function floodFill(t,e,n){const a=brushSize/10*25,o=getPx(t,e);if(colorDist(o,n)<a)return;let r=new Uint8Array(w*h),i=[[t,e]];for(;i.length;){let[t,e]=i.pop();if(t<0||t>=w||e<0||e>=h)continue;let s=e*w+t;r[s]||(r[s]=1,colorDist(getPx(t,e),o)>a||(setPx(t,e,n,brushHard/100,!1),i.push([t+1,e],[t-1,e],[t,e+1],[t,e-1])))}drawAll()}function applyRect(t,e,n,a,o){let r=Math.min(t,n),i=Math.max(t,n),s=Math.min(e,a),l=Math.max(e,a);for(let t=r;t<=i;t++)applyBrush(t,s,o,!1),applyBrush(t,l,o,!1);for(let t=s+1;t<l;t++)applyBrush(r,t,o,!1),applyBrush(i,t,o,!1);drawAll()}function applyCircle(t,e,n,a,o){const r=(t+n)/2,i=(e+a)/2,s=Math.abs(n-t)/2,l=Math.abs(a-e)/2,c=Math.max(300,Math.ceil(2*Math.PI*Math.max(s,l)));for(let t=0;t<c;t++){const e=t/c*2*Math.PI;applyBrush(Math.round(r+s*Math.cos(e)),Math.round(i+l*Math.sin(e)),o,!1)}drawAll()}function initWS(){ws&&ws.readyState===WebSocket.OPEN||(ws=connectWs()),fetch(`${wu}/json/info`).then((t=>t.json())).then((t=>{maxColInd="esp8266"===t.arch?35:85})).catch((()=>{})),ws||(maxColInd=256)}function connectWs(){try{if(top.window.ws&&top.window.ws.readyState===WebSocket.OPEN)return top.window.ws}catch(t){}let t=loc?`${wu}/ws`.replace("http","ws"):"ws://"+window.location.hostname+"/ws",e=new WebSocket(t);return e.binaryType="arraybuffer",e.addEventListener("close",(()=>ws=null)),e.addEventListener("error",(()=>ws=null)),e}async function reqJson(t){if(ws&&1==ws.readyState)try{return ws.send(JSON.stringify(t)),1}catch(t){}return window._httpQ||(window._httpQ=[],window._httpRun=0),_httpQ.length>=5?-1:new Promise((e=>{_httpQ.push({cmd:t,resolve:e}),async function(){if(!_httpRun){for(_httpRun=1;_httpQ.length;){let t=_httpQ.shift();try{await fetch(`${wu}/json`,{method:"post",body:JSON.stringify(t.cmd),cache:"no-store"})}catch(t){}await new Promise((t=>setTimeout(t,120))),t.resolve(0)}_httpRun=0}}()}))}async function sendDirty(t){if(!prvEn||!curSeg)return;let e=20,n=!1;if(t||(t=matrix.map(((t,e)=>({idx:e,hex:c2h(t.r,t.g,t.b)}))),e=40,n=!0),!t.length)return;t.sort(((t,e)=>t.idx-e.idx));let a=[];for(let o of t)if(!(o.idx>=matrix.length)&&(a.push((curSeg.start||0)+o.idx,o.hex),a.length>=2*maxColInd)){if(n&&painting)return;await reqJson({seg:{id:curSeg.id,i:a}}),a=[],await new Promise((t=>setTimeout(t,e)))}a.length&&(await reqJson({seg:{id:curSeg.id,i:a}}),await new Promise((t=>setTimeout(t,e))));for(let e of t)e.idx<matrix.length&&(lastSentMtx[e.idx]=e.hex)}function paintCmp(){prvTmr=setTimeout((async()=>{prvTmr=null;const t=[];for(let e=0;e<matrix.length;e++){const n=matrix[e],a=c2h(n.r,n.g,n.b);lastSentMtx[e]!==a&&t.push({idx:e,hex:a})}t.length&&await sendDirty(t),painting&&prvEn&&paintCmp()}),50)}function openImage(){const t=document.getElementById("imgFile");t.value="",t.onchange=t=>{const e=t.target.files[0];if(!e)return;const n=new Image;n.onload=()=>{offCanv.width=n.width,offCanv.height=n.height,offCtx.drawImage(n,0,0,n.width,n.height);const t=offCtx.getImageData(0,0,n.width,n.height).data;if(!is1D||w*h!=n.width*n.height&&w*h!=n.width*n.height-1){offCanv.width=w,offCanv.height=h,offCtx.drawImage(n,0,0,w,h);const t=offCtx.getImageData(0,0,w,h).data;for(let e=0;e<w*h;e++)matrix[e]={r:t[4*e],g:t[4*e+1],b:t[4*e+2]}}else{let e=0;for(let a=0;a<n.height&&e<matrix.length;a++)for(let o=0;o<n.width&&e<matrix.length;o++){const r=4*(a*n.width+o);matrix[e++]={r:t[r],g:t[r+1],b:t[r+2]}}updateMatrix()}drawAll(),prvEn&&sendDirty()},n.src=URL.createObjectURL(e)},t.click()}async function savePreset(t,e=0){console.log("Saving preset with color reduction:",e);let n=document.getElementById("fn").value.trim()||"mypaint";if(e&&(n+="[reduced]"),!n)return;const a=[],o=255>>e<<e;for(let t=0;t<w*h;t++)a[t]=c2h(matrix[t].r&o,matrix[t].g&o,matrix[t].b&o);const r=[];let i=0,s=a[0];for(let t=1;t<=a.length;t++)t!==a.length&&a[t]===s||(r.push(...t-i==1?[s]:[i,t,s]),t<a.length&&(i=t,s=a[t]));const l=JSON.parse(document.getElementById("seg").selectedOptions[0].dataset.segData||"{}");try{const t=await(await fetch(`${wu}/presets.json`)).json(),e=Math.max(...Object.keys(t).map((t=>parseInt(t))).filter((t=>!isNaN(t))),0)+1;if(!(await(await fetch(`${wu}/json`,{method:"POST",body:JSON.stringify({on:!0,bri:globalBri,seg:{id:l.id||0,start:l.start||0,stop:l.stop||mW.value,len:l.len||mW.value,grp:l.grp||1,spc:l.spc||0,of:l.of||0,on:!0,frz:!0,bri:l.bri||255,bm:l.bm||0,rev:l.rev||!1,i:r},n:n,o:!1,psave:e})})).json()).success)throw new Error;showToast(`Preset "${n}" saved as ID ${e}`)}catch(n){if(e<4)return showToast("Preset too large, reducing colors",!0),await savePreset(t,e+1);showToast(`Error: ${n.message}`,!0)}}function genPal(t){const e=new Map;for(let n=0;n<t.length;n+=4){const a=t[n]<<16|t[n+1]<<8|t[n+2];e.set(a,(e.get(a)||0)+1)}let n=[Array.from(e,(([t,e])=>({r:t>>16&255,g:t>>8&255,b:255&t,count:e})))];for(;n.length<256&&n.some((t=>t.length>1));){n.sort(((t,e)=>e.length-t.length));const t=n.shift(),e=["r","g","b"].map((e=>({k:e,range:Math.max(...t.map((t=>t[e])))-Math.min(...t.map((t=>t[e])))}))).reduce(((t,e)=>t.range>e.range?t:e)).k;t.sort(((t,n)=>t[e]-n[e]));const a=t.length>>1;n.push(t.slice(0,a),t.slice(a))}const a=n.map((t=>{const e=t.reduce(((t,e)=>t+e.count),0);return Math.round(t.reduce(((t,e)=>t+e.r*e.count),0)/e)<<16|Math.round(t.reduce(((t,e)=>t+e.g*e.count),0)/e)<<8|Math.round(t.reduce(((t,e)=>t+e.b*e.count),0)/e)}));let o=1;for(;o<a.length;)o<<=1;for(let t=a.length;t<o;t++)a[t]=a[a.length-1];const r=new Uint8Array(t.length/4);for(let e=0,o=0;e<t.length;e+=4,o++){let i=t[e],s=t[e+1],l=t[e+2],c=0,d=1e9;for(let t=0;t<n.length;t++){const e=a[t],n=(i-(e>>16&255))**2+(s-(e>>8&255))**2+(l-(255&e))**2;n<d&&(d=n,c=t)}r[o]=c}return{indexed:r,palette:a}}function palPad(t){let e=1;for(;e<t.length;)e<<=1;for(;t.length<e;)t.push(t[t.length-1]);return t}function grid(t){if(t<=320)return{w:t,h:1};let e=[1,t],n=t;for(let a=320;a>=2;a--){const o=Math.ceil(t/a),r=a*o-t;if(r<n&&(e=[a,o],n=r,!n))break}return{w:e[0],h:e[1]}}async function saveGIF(){let t=document.getElementById("fn").value.trim()||"mypaint";t.endsWith(".gif")||(t+=".gif");let e=!1;try{const n=await fetch(`${wu}/edit?list=/`);e=(await n.json()).some((e=>e.name==="/"+t&&e.name.toLowerCase().endsWith(".gif")))}catch(t){console.error("Error fetching file list:",t)}if(!e||confirm(`${t} already exists. Do you want to overwrite it?`))try{let e=w,n=h;if(is1D){const t=grid(w);e=t.w,n=t.h}const a=new Uint8Array(e*n*4);for(let t=0;t<e*n;t++){const e=matrix[t]||matrix[w*h-1];a[4*t]=e.r,a[4*t+1]=e.g,a[4*t+2]=e.b,a[4*t+3]=255}const o=new ImageData(new Uint8ClampedArray(a),e,n);let{indexed:r,palette:i}=genPal(o.data);const s=[],l=new window.GifWriter(s,e,n,{loop:0,palette:i});l.addFrame(0,0,e,n,r),l.end();const c=new File([new Uint8Array(s)],t,{type:"image/gif"}),d=new FormData;d.append("file",c,t);(await fetch(`${wu}/upload`,{method:"POST",body:d})).ok?showToast(`${t} saved`):showToast("Upload failed",!0)}catch(t){showToast(`Error: ${t.message}`,!0)}}function showToast(t,e=!1){const n=document.createElement("div");Object.assign(n.style,{position:"fixed",bottom:"20px",right:"20px",background:e?"#e00":"#555",color:"#fff",padding:"10px 20px",borderRadius:"10px",fontSize:"14px",zIndex:"1000"}),n.textContent=t,document.body.appendChild(n),setTimeout((()=>n.remove()),5e3)}(async()=>{wu=`http://${new URLSearchParams(window.location.search).get("host")||window.location.host}`;const t=document.getElementById("seg");try{const e=await fetch(`${wu}/json/state`),n=await e.json();if(globalBri=n.bri||128,segs=n.seg||[],t.innerHTML="",segs.length)segs.forEach((e=>{const{id:n,n:a,start:o,stop:r,startY:i,stopY:s,grp:l,spc:c}=e,d=new Option(a||`Segment ${n}`,n),h=l||1,u=c||0,w=s-i;d.dataset.w=Math.ceil((r-o)/(h+u)),d.dataset.h=w>1?Math.ceil(w/(h+u)):1,d.dataset.segData=JSON.stringify(e),t.add(d)}));else{const e=new Option("Segment 0",0);e.dataset.w=16,e.dataset.h=16,e.dataset.segData=JSON.stringify({id:0,start:0,stop:16,len:16,grp:1,spc:0,of:0,on:!0,bri:255,bm:0,rev:!1}),t.add(e)}const a=t.options[t.selectedIndex];a&&(mW.value=a.dataset.w||16,mH.value=a.dataset.h||16,updateMatrix())}catch(t){console.error(t)}})(),iroPicker=new iro.ColorPicker("#iroPicker",{width:168,color:"#ff6600",layout:[{component:iro.ui.Wheel},{component:iro.ui.Slider,options:{sliderType:"value"}}]}),document.getElementById("sizeSlider").oninput=t=>{brushSize=parseFloat(t.target.value),document.getElementById("brushSizeLabel").textContent=brushSize.toFixed(1)},document.getElementById("hardnessSlider").oninput=t=>{brushHard=+t.target.value,document.getElementById("brushHardnessLabel").textContent=brushHard},document.getElementById("seg").onchange=async t=>{const e=t.target.selectedOptions[0];if(mW.value=e.dataset.w,mH.value=e.dataset.h,updateMatrix(),prvEn){curSeg&&await reqJson({seg:{id:curSeg.id,frz:!1}});const e=+t.target.value;curSeg=segs.find((t=>t.id===e))||{id:e,start:0},await reqJson({seg:{id:curSeg.id,frz:!0}}),lastSentMtx=new Array(w*h).fill(null),await sendDirty()}},mW.onchange=mH.onchange=updateMatrix,window.addEventListener("resize",(()=>{is1D&&(clearTimeout(resizeTmr),resizeTmr=setTimeout((()=>{const t=selRow;createRowCanv(),t<rowCanv.length&&(selRow=t)}),100))})),canv.addEventListener("pointerdown",(t=>startPaint(t,"2d"))),canv.addEventListener("pointermove",(t=>{t.preventDefault(),painting&&paint(t,"2d")})),canv.addEventListener("pointerleave",(()=>{preview=lastPos=null,drawAll()})),canvPrev1D.addEventListener("pointerdown",(t=>startPaint(t,"1d"))),canvPrev1D.addEventListener("pointermove",(t=>{t.preventDefault(),painting&&paint(t,"1d")})),canvPrev1D.addEventListener("pointerleave",(()=>{lastPos=null,drawAll()})),document.addEventListener("pointerup",endPaint),window.addEventListener("beforeunload",(()=>{prvEn&&!document.getElementById("frz").checked&&reqJson({seg:{frz:!1}})})),updateMatrix(),togglePreview()</script>