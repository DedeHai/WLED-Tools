<!doctypehtml><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1"><meta name=author content=@dedehai><meta name=license content="EUPL v. 1.2 or later"><link rel="shortcut icon"href=favicon.ico><link rel=stylesheet href=style.css><title>WLED VideoLab</title><script src=https://cdn.jsdelivr.net/npm/omggif@1.0.10/omggif.min.js></script><script src=common.js></script><style>body{font-family:Verdana,sans-serif;font-size:1rem;text-align:center;background:#222;color:#fff;line-height:200%;margin:0 auto;padding:8px;max-width:800px;box-sizing:border-box}*,::after,::before{box-sizing:border-box}.title{font-size:28px;font-weight:700;padding:12px 0;margin-bottom:12px}.title .rb{background:repeating-linear-gradient(#f55 0 4px,#222 4px 5px,#6f6 5px 10px,#222 10px 11px,#88f 11px 16px,#222 16px 17px);background-size:100% 17px;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:rgbshift 4s linear 10;font-size:36px}@keyframes rgbshift{to{background-position:0 34px}}.drop,.editor,.presets{background:#222;border-radius:8px;margin:20px auto}.drop{border:2px dashed #555;padding:40px 20px;cursor:pointer;transition:all .3s ease;max-width:60%;text-align:center}.drop:hover{border-color:#48a;background:#333}.editor{display:none;padding:20px}.editor.active{display:block}.ctrlw{display:flex;flex-direction:column;gap:5px;align-items:center;width:100%}.cropw{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:15px 0}#canvas,#prev,#pv{background:#333;border:2px solid #555;border-radius:8px}#canvas{cursor:crosshair;max-width:90%;touch-action:none}#pv{image-rendering:pixelated;border-radius:4px}.slrow{text-align:center;margin-bottom:5px;width:100%;max-width:500px}.slrow label{display:block;margin-bottom:5px}.slider{width:100%}.toast{position:fixed;top:20px;right:20px;background:#555;color:#fff;padding:12px 20px;border-radius:8px;font-size:14px;z-index:9999;border:2px solid #888}.btn,button,input,select{background:#333;color:#fff;font-family:Verdana,sans-serif;border:.5ch solid #333;font-size:medium;margin:2px}.btn,button{border-radius:24px;font-size:20px;margin:8px 4px;padding:8px 12px;min-width:48px;cursor:pointer;transition:all .3s ease}.btn:hover,button:hover{background:#555;border-color:#555}button.sml{padding:8px 12px;border-radius:25px;font-size:15px;min-width:45px;margin:0 0 0 10px}#file,#video{display:none}.presets{padding:15px}.presets h3{margin-top:0}.prow{display:flex;align-items:center;gap:8px;margin:8px 0}.prow button{text-align:left;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.dialog{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#333;padding:25px;border-radius:8px;border:2px solid #555;z-index:10000;min-width:320px;display:none;text-align:center}.dialog.active{display:block}.dialog input{width:80%;background:#555;border:none;color:#fff;padding:8px 14px;border-radius:4px;margin:10px auto;display:block}.vctrl{display:flex;flex-direction:column;align-items:center;gap:8px;width:100%;max-width:800px;margin-top:8px}.prow2{display:flex;gap:10px;align-items:center;width:100%}.brow{display:flex;justify-content:center;gap:10px;width:100%}.bcont{display:flex;gap:10px}.spcont{display:flex;align-items:center;gap:8px}.pwrap{position:relative;flex:1 1 0;min-width:0;width:100%;height:28px;display:flex;align-items:center;overflow:visible}.pwrap .pbar{-webkit-appearance:none;appearance:none;width:100%;height:8px;background:#444;border-radius:6px;margin:0;outline:0}.pwrap .pbar::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:#fff;border-radius:50%;border:2px solid #08d}.tdisp{font-size:14px;color:#ccc;min-width:90px;text-align:right}.lregn{position:absolute;top:50%;transform:translateY(-50%);height:8px;background:rgba(8,141,255,.25);border-radius:4px;pointer-events:none;z-index:0}.lmark{position:absolute;top:50%;transform:translate(-50%,-50%);width:14px;height:20px;background:0 0;border-radius:2px;z-index:2;cursor:ew-resize;touch-action:none}.lmark::before{content:'';position:absolute;top:0;width:3px;height:100%;background:#4af;box-shadow:0 0 4px rgba(0,0,0,.6)}.lmark.start::before{left:0;border-radius:2px 0 0 2px;border-left:2px solid #08d}.lmark.end::before{right:0;border-radius:0 2px 2px 0;border-right:2px solid #08d}#url{flex:1;padding:6px;border-radius:8px}.exrow{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:6px}input[type=number]{width:4em}input[type=color]{width:40px;height:40px;border-radius:50%;padding:0;border-width:0}#ovlay{position:fixed;inset:0;display:none;z-index:9998}#ovlay.loading{display:block;background:rgba(0,0,0,.6)}#ovlay.loading::after{content:"Processing...";position:absolute;left:50%;top:45%;transform:translate(-50%,-50%);background:#222;padding:12px 18px;border-radius:8px;border:2px solid #444;color:#fff;font-size:16px}@media (max-width:600px){.vctrl{flex-direction:column}.prow2{order:-1}.brow{justify-content:center;flex-wrap:wrap}.spcont{width:100%;justify-content:center}input[type=range]{min-width:120px;width:60%}}</style><div style=position:absolute;top:0;left:10px;font-size:10px;color:#666>v0.91beta</div><div class=cont><div class=title>WLED<span class=rb>VideoLab</span></div><h3 id=mt style=margin-top:20px>Target Matrix:</h3><h3>Load Video</h3><div id=dropz class=drop><p>Drop video or click to select</div><input type=file id=file accept=video/*><div style=display:flex;gap:8px;align-items:center;flex-wrap:wrap><div style=flex-basis:100%>Play from CORS enabled URL:</div><input id=url><button class=sml id=loadU title="Play URL">‚ñ∂</button></div><h5>Example: https://cdn.pixabay.com/video/2023/01/08/145766-787427612_tiny.mp4</h5><div class=presets id=prests style=display:none><h3>Saved Video Presets</h3><div id=plist></div></div><div class=editor id=editor><div class=cropw><button class=sml id=mAsp>Match Aspect Ratio</button><button class=sml id=mSize>Match Size (1:1)</button><button class=sml id=fSize>Full Size</button><button class=sml id=rCrop>Reset</button></div><div class=ctrlw><div style=width:100%><canvas id=canvas width=800 height=600></canvas></div><div class=vctrl id=vctrl style=display:none><div class=prow2><div class=pwrap id=pwrap><div class=lregn id=lregn style=left:0;width:0></div><div class="lmark start"id=lstart title="Loop start"></div><div class="lmark end"id=lend title="Loop end"></div><input type=range id=prog min=0 max=100 value=0 step=0.1 class=pbar aria-label=progress></div><span id=tdisp class=tdisp>0:00 / 0:00</span></div><div class=brow><div class=bcont><button id=play class=sml title=Play/Pause>‚è∏</button><button id=mute class=sml title=Mute/unmute>üîä</button><button id=stop class=sml title=Stop>‚èπ</button></div><div class=spcont><input type=range id=speed min=0.1 max=4 step=0.1 value=1><span class=value id=spLbl>1.0x</span></div></div></div><small>Preview at target resolution</small><canvas id=pv></canvas><div class=slrow><label>Dark Pixel Cutoff:<span id=btVal>0</span></label><input type=range id=bt min=0 max=255 value=0 class=slider></div><div class=slrow><label>Brightness:<span id=brVal>255</span></label><input type=range id=br min=0 max=255 value=255 class=slider></div><div class=slrow><label>Gamma Correction:<span id=gmVal>2.2</span></label><input type=range id=gm min=0.1 max=4 step=0.01 value=2.2 class=slider></div><div style="display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0"><label for=bg>Background Color</label><input type=color id=bg value=#000000></div></div><div class=exrow><button class=btn id=saveP style=display:none>Save Video Preset</button><button class=btn id=expGif style=display:none title="Export preview as GIF">Export GIF</button></div></div><div style="text-align:center;margin:20px 0"><button class=btn onclick="window.location.href=wu">Back to the controls</button></div><div style=font-size:12px;color:#666>by @dedehai</div></div><div class=dialog id=saveDlg><h3 style=margin-top:0>Save Video Preset</h3><label>Name (max 32 chars):</label><input id=pname maxlength=32 placeholder="Enter a name..."><div class=btns style=display:flex;gap:10px;justify-content:center;margin-top:15px><button class=btn id=saveOk>Save</button><button class=btn id=saveCn>Cancel</button></div></div><div class=dialog id=expDlg><h3 style=margin-top:0>Export GIF</h3><div style="max-width:300px;margin:0 auto"><div style="display:flex;align-items:center;gap:8px;margin:8px 0"><label style=min-width:60px>Name:</label><input id=gname maxlength=32 placeholder=myvideo style=flex:1;margin:0></div><div style="display:flex;align-items:center;gap:8px;margin:8px 0"><label style=min-width:60px>FPS:</label><input type=number id=gfps value=20 min=0.01 max=33 step=1 style=flex:1;background:#555;color:#fff;border-radius:6px;padding:6px;margin:0></div><div style="display:flex;align-items:center;gap:8px;margin:8px 0"><label style=min-width:60px>Colors:</label><input type=range id=cdepth min=4 max=8 step=1 value=8 class=slider style=flex:1;margin:0><span id=colLbl style=min-width:40px;text-align:right>256</span></div></div><div class=btns style=display:flex;gap:10px;justify-content:center;margin-top:15px><button class=btn id=expOk>Export</button><button class=btn id=expCn>Cancel</button></div></div><div class=dialog id=resDlg><h3 style=margin-top:0>GIF Ready</h3><img id=gifPrv style="margin:10px auto;image-rendering:pixelated;border:1px solid #555;border-radius:8px;display:none"><p id=gifInf><div class=btns style=display:flex;gap:10px;justify-content:center;margin-top:15px><button class=btn id=gifUp>Upload</button><button class=btn id=gifDl>Download</button><button class=btn id=gifCn>Cancel</button></div></div><div id=ovlay></div><video id=video autoplay playsinline loop crossorigin=anonymous></video><script>const cvs=gId("canvas"),ctx=cvs.getContext("2d",{willReadFrequently:!0}),pv=gId("pv"),pvx=pv.getContext("2d",{willReadFrequently:!0}),vid=gId("video"),capCvs=document.createElement("canvas"),capCtx=capCvs.getContext("2d",{willReadFrequently:!0}),dsCvs=document.createElement("canvas"),dsCtx=dsCvs.getContext("2d",{willReadFrequently:!0});let rgbBuf=null,lut=new Uint8ClampedArray(256),thr=0,bgc=[0,0,0],bri=1,wu="",ws=null,mw=32,mh=32,crop={x:50,y:50,w:200,h:150},drag=!1,hand=null,offX=0,offY=0,vInp=null,vRect={x:0,y:0,w:0,h:0},keepSend=!0,lStart=0,lEnd=null;const playBtn=gId("play"),muteBtn=gId("mute"),prog=gId("prog"),tDisp=gId("tdisp"),spdSl=gId("speed");let sendBusy=!1,lastSend=0;const CAP_INT=33,QUEUE_MAX=65536,pWrap=gId("pwrap"),lRegn=gId("lregn"),lSt=gId("lstart"),lEd=gId("lend");let mDrag=null;function msg(e,t){const n=document.createElement("div");n.className="toast",n.textContent=e,"error"===t&&(n.style.background="#d32f2f"),document.body.appendChild(n),setTimeout((()=>n.remove()),3e3)}function ovShow(){const e=gId("ovlay");e&&(e.style.display="block",e.classList.add("loading"))}function ovHide(){const e=gId("ovlay");e&&(e.classList.remove("loading"),e.style.display="none")}async function loadSize(){const e=gId("mt");try{const t=await fetch(`${wu}/json/info`),n=await t.json();if(n.leds.matrix&&n.leds.matrix.w&&n.leds.matrix.h){const{w:t,h:a}=n.leds.matrix;e.textContent=`Target Matrix: ${t}x${a}`,mw=t,mh=a}else mw=n.leds.count,mh=1,e.textContent=`Target Strip: ${mw} LEDs`;initCapBuffers()}catch(e){console.error(e)}}function initCapBuffers(){capCvs.width=mw,capCvs.height=mh,rgbBuf=new Uint8Array(mw*mh*3)}function buildLUT(){bri=+gId("br").value/255,thr=+gId("bt").value,bgc=gId("bg").value.match(/\w\w/g).map((e=>parseInt(e,16)));const e=+gId("gm").value;for(let t=0;t<256;t++)lut[t]=Math.min(255,Math.round(255*Math.pow(t*bri/255,e)))}function loadGamma(e){if(e)return localStorage.setItem("gamma",e),gId("gmVal").textContent=e,void buildLUT();const t=localStorage.getItem("gamma")||2.2;gId("gm").value=t,gId("gmVal").textContent=t}function handleFile(){const e=gId("file").files[0];if(!e)return;if(!e.type.startsWith("video/"))return void msg("Only video files supported","error");stopVid();const t=URL.createObjectURL(e);vid.src=t,vid.load(),vid.addEventListener("loadedmetadata",(()=>startCap(e.name,!1)),{once:!0}),vid.play().catch((e=>{msg("Failed to load: "+e.message,"error"),URL.revokeObjectURL(t)}))}function loadUrl(e){return new Promise(((t,n)=>{try{stopVid(),vid.src=e,vid.load();const a=()=>{startCap(e.split("/").pop(),!0),t()};vid.addEventListener("loadedmetadata",a,{once:!0}),vid.play().catch((e=>{vid.removeEventListener("loadedmetadata",a),n(e)}))}catch(e){n(e)}}))}function stopVid(){if(vfcHandle){try{vid.cancelVideoFrameCallback(vfcHandle)}catch(e){}vfcHandle=null}if(loopInt&&(clearInterval(loopInt),loopInt=null),keepSend=!1,vid.src){const e=vid.src;vid.pause(),vid.src="",vid.load(),e.startsWith("blob:")&&URL.revokeObjectURL(e)}gId("saveP").style.display="none",gId("expGif").style.display="none",gId("editor").classList.remove("active")}function startCap(){gId("editor").classList.add("active");const e=vid.videoHeight/vid.videoWidth;vid.videoWidth/vid.videoHeight>800/600?(cvs.height=600,cvs.width=Math.round(600/e)):(cvs.width=Math.min(800,vid.videoWidth),cvs.height=Math.round(cvs.width*e));const t=Math.min(cvs.width/vid.videoWidth,cvs.height/vid.videoHeight);vRect.w=vid.videoWidth*t,vRect.h=vid.videoHeight*t,vRect.x=(cvs.width-vRect.w)/2,vRect.y=(cvs.height-vRect.h)/2,vInp=vid,initCrop(),vfcHandle||(vfcHandle=vid.requestVideoFrameCallback(onVFrame)),capFrame(),gId("vctrl").style.display="flex",gId("saveP").style.display="inline-block",gId("expGif").style.display="inline-block",vid.duration&&!isNaN(vid.duration)&&(lEnd=vid.duration,clampLoop(),updMarks())}function updTime(){const e=e=>{if(!e||isNaN(e))return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`};tDisp&&(tDisp.textContent=`${e(vid.currentTime)} / ${e(vid.duration)}`)}(async()=>{getLoc();const e=new URLSearchParams(window.location.search);wu=`http://${e.get("host")||window.location.host}`,ws=connectWs((()=>console.log("WS connected"))),await loadSize(),loadGamma(),buildLUT(),loadPresets()})(),setInterval((()=>{vid.paused&&vInp&&!capBusy&&capFrame()}),50),gId("gm").oninput=e=>loadGamma(e.target.value),gId("cdepth").oninput=e=>gId("colLbl").textContent=1<<e.target.value,gId("dropz").onclick=()=>{gId("file").value="",gId("file").click()},gId("dropz").ondragover=e=>{e.preventDefault(),gId("dropz").classList.add("active")},gId("dropz").ondragleave=()=>gId("dropz").classList.remove("active"),gId("dropz").ondrop=e=>{e.preventDefault(),gId("dropz").classList.remove("active"),gId("file").files=e.dataTransfer.files,handleFile()},gId("file").onchange=handleFile,gId("loadU").onclick=()=>{const e=gId("url").value.trim();e?loadUrl(e).catch((e=>msg("Failed to load: "+e.message,"error"))):msg("Enter a URL","error")},vid.addEventListener("play",(()=>{playBtn&&(playBtn.textContent="‚è∏")})),vid.addEventListener("pause",(()=>{playBtn&&(playBtn.textContent="‚ñ∂")})),playBtn&&(playBtn.onclick=()=>{vid.paused?vid.play().then((()=>{playBtn.textContent="‚è∏",keepSend=!0})).catch((()=>{})):(vid.pause(),playBtn.textContent="‚ñ∂",keepSend=!0)}),muteBtn&&(muteBtn.onclick=()=>{vid.muted=!vid.muted,muteBtn.textContent=vid.muted?"üîá":"üîä"}),prog&&(prog.addEventListener("input",(e=>{e.preventDefault(),prog.dragging=!0}),{passive:!1}),prog.addEventListener("change",(()=>{vid.duration&&!isNaN(vid.duration)&&(vid.currentTime=prog.value/100*vid.duration),prog.dragging=!1}))),vid.addEventListener("loadedmetadata",(()=>{updTime(),lEnd=vid.duration,clampLoop(),updMarks()})),vid.addEventListener("timeupdate",(()=>{prog.dragging||!vid.duration||isNaN(vid.duration)||(prog.value=vid.currentTime/vid.duration*100),updTime()})),spdSl&&(spdSl.oninput=e=>{const t=parseFloat(e.target.value);vid.playbackRate=t,gId("spLbl").textContent=t.toFixed(1)+"x"}),gId("stop").onclick=()=>{stopVid(),vInp=null,gId("editor").classList.remove("active"),msg("Stopped")};let capBusy=!1,vfcHandle=null;function onVFrame(){capBusy||capFrame(),vfcHandle=vid.requestVideoFrameCallback(onVFrame)}async function capFrame(){if(!capBusy&&vid.videoWidth){capBusy=!0;try{await updateDownscale(),updPrev();const e=(crop.x-vRect.x)/vRect.w*dsCvs.width,t=(crop.y-vRect.y)/vRect.h*dsCvs.height,n=crop.w/vRect.w*dsCvs.width,a=crop.h/vRect.h*dsCvs.height;capCtx.imageSmoothingEnabled=!1,capCtx.fillStyle=gId("bg").value,capCtx.fillRect(0,0,mw,mh),capCtx.drawImage(dsCvs,e,t,n,a,0,0,mw,mh);const d=capCtx.getImageData(0,0,mw,mh);applyFilt(d,!0),capCtx.putImageData(d,0,0);for(let e=0,t=0;e<d.data.length;e+=4,t+=3)rgbBuf[t]=d.data[e],rgbBuf[t+1]=d.data[e+1],rgbBuf[t+2]=d.data[e+2];pvx.imageSmoothingEnabled=!1,pvx.drawImage(capCvs,0,0,mw,mh,0,0,pv.width,pv.height);const o=performance.now();ws&&1===ws.readyState&&!sendBusy&&o-lastSend>=CAP_INT&&ws.bufferedAmount<QUEUE_MAX&&(sendBusy=!0,lastSend=o,sendDDP(ws,0,mw*mh,rgbBuf),sendBusy=!1)}catch(e){console.error(e),sendBusy=!1}capBusy=!1}}function applyFilt(e,t){const n=e.data,a=thr,d=bgc[0],o=bgc[1],r=bgc[2];for(let e=0;e<n.length;e+=4){let i=n[e],c=n[e+1],s=n[e+2];i<a&&c<a&&s<a?(n[e]=d,n[e+1]=o,n[e+2]=r):t?(n[e]=lut[i],n[e+1]=lut[c],n[e+2]=lut[s]):(n[e]=Math.min(255,Math.round(i*bri)),n[e+1]=Math.min(255,Math.round(c*bri)),n[e+2]=Math.min(255,Math.round(s*bri)))}}const DS_MAX_W=600,DS_MAX_H=600;function updateDownscale(){const e=vid.videoWidth,t=vid.videoHeight;if(!e||!t)return;const n=Math.min(1,DS_MAX_W/e,DS_MAX_H/t),a=Math.max(1,Math.round(e*n)),d=Math.max(1,Math.round(t*n));dsCvs.width=a,dsCvs.height=d,dsCtx.imageSmoothingEnabled=!1,dsCtx.drawImage(vid,0,0,e,t,0,0,dsCvs.width,dsCvs.height)}function updPrev(){ctx.drawImage(dsCvs,0,0,dsCvs.width,dsCvs.height,vRect.x,vRect.y,vRect.w,vRect.h),drawCrop()}function drawCrop(){ctx.lineWidth=3,ctx.setLineDash([6,4]),ctx.shadowColor="#000",ctx.shadowBlur=2,ctx.strokeStyle="#FFF",ctx.beginPath(),ctx.roundRect(crop.x,crop.y,crop.w,crop.h,6),ctx.stroke(),ctx.shadowColor="#000F"}function initCrop(){const e=mw/mh,t=vRect.w,n=vRect.h;t/n>e?(crop.h=.8*n,crop.w=crop.h*e):(crop.w=.8*t,crop.h=crop.w/e),crop.x=vRect.x+(t-crop.w)/2,crop.y=vRect.y+(n-crop.h)/2,updPrev();const a=mh/mw;a>1?(pv.height=256,pv.width=Math.max(8,Math.round(256/a))):(pv.width=256,pv.height=Math.max(8,Math.round(256*a)))}function clampCrop(){crop.w=Math.max(30,Math.min(crop.w,vRect.w)),crop.h=Math.max(30,Math.min(crop.h,vRect.h)),crop.x=Math.max(vRect.x,Math.min(crop.x,vRect.x+vRect.w-crop.w)),crop.y=Math.max(vRect.y,Math.min(crop.y,vRect.y+vRect.h-crop.h))}function getHandles(e){const t=40,n=e.x-20,a=e.y-20,d=e.w+t,o=e.h+t;return{nw:{x:n,y:a,w:t,h:t},ne:{x:n+d-t,y:a,w:t,h:t},sw:{x:n,y:a+o-t,w:t,h:t},se:{x:n+d-t,y:a+o-t,w:t,h:t},n:{x:n+20,y:a,w:d-t,h:t},s:{x:n+20,y:a+o-t,w:d-t,h:t},w:{x:n,y:a+20,w:t,h:o-t},e:{x:n+d-t,y:a+20,w:t,h:o-t}}}function hitTest(e,t){const n=getHandles(crop);for(const a in n){const d=n[a];if(e>=d.x&&e<=d.x+d.w&&t>=d.y&&t<=d.y+d.h)return a}return null}function getPos(e){const t=cvs.getBoundingClientRect(),n=cvs.width/t.width,a=cvs.height/t.height;let d,o;return e.touches&&e.touches.length?(d=e.touches[0].clientX,o=e.touches[0].clientY):e.changedTouches&&e.changedTouches.length?(d=e.changedTouches[0].clientX,o=e.changedTouches[0].clientY):(d=e.clientX,o=e.clientY),{x:(d-t.left)*n,y:(o-t.top)*a}}function startDrag(e,t){hand=hitTest(e,t),hand?drag=!0:e>crop.x&&e<crop.x+crop.w&&t>crop.y&&t<crop.y+crop.h&&(drag=!0,hand="move",offX=e-crop.x,offY=t-crop.y)}function moveDrag(e,t){if(drag){switch(hand){case"move":crop.x=e-offX,crop.y=t-offY;break;case"nw":crop.w+=crop.x-e,crop.h+=crop.y-t,crop.x=e,crop.y=t;break;case"ne":crop.w=e-crop.x,crop.h+=crop.y-t,crop.y=t;break;case"sw":crop.w+=crop.x-e,crop.x=e,crop.h=t-crop.y;break;case"se":crop.w=e-crop.x,crop.h=t-crop.y;break;case"n":crop.h+=crop.y-t,crop.y=t;break;case"s":crop.h=t-crop.y;break;case"w":crop.w+=crop.x-e,crop.x=e;break;case"e":crop.w=e-crop.x}clampCrop()}}function endDrag(){drag=!1,hand=null}function getPresets(){try{return JSON.parse(localStorage.getItem("wled_video_presets")||"[]")}catch(e){return[]}}function savePresets(e){localStorage.setItem("wled_video_presets",JSON.stringify(e))}function loadPresets(){const e=getPresets(),t=gId("plist"),n=gId("prests");e.length?(n.style.display="block",t.innerHTML="",e.forEach(((e,n)=>{const a=document.createElement("div");a.className="prow";const d=document.createElement("button");d.className="sml",d.style.flex="1",d.textContent=e.name,d.title=e.url||"(local preset)",d.onclick=async()=>{try{e.url?(gId("url").value=e.url,await loadUrl(e.url),applyPreset(e)):applyPreset()}catch(e){msg("Preset error","error")}};const o=document.createElement("button");o.className="sml",o.textContent="‚ü≥",o.onclick=()=>{if(confirm(`Update "${e.name}"?`)){const e=getPresets(),t=e[n].name;e.splice(n,1),addPreset(e),e[e.length-1].name=t,savePresets(e),loadPresets(),msg("Preset updated")}};const r=document.createElement("button");r.className="sml",r.textContent="‚úï",r.onclick=()=>{if(confirm(`Delete "${e.name}"?`)){const e=getPresets();e.splice(n,1),savePresets(e),loadPresets(),msg("Preset deleted")}},a.append(d,o,r),t.appendChild(a)}))):n.style.display="none"}function applyPreset(e){if(e.url&&(gId("url").value=e.url),e.crop&&(crop={...e.crop},clampCrop()),gId("bt").value=e.bt??gId("bt").value,gId("btVal").textContent=gId("bt").value,gId("br").value=e.br??gId("br").value,gId("brVal").textContent=gId("br").value,gId("gm").value=e.gm??gId("gm").value,gId("gmVal").textContent=gId("gm").value,gId("bg").value=e.bg??gId("bg").value,buildLUT(),void 0!==e.mute&&(vid.muted=!!e.mute),void 0!==e.speed&&(vid.playbackRate=e.speed,gId("speed").value=e.speed,gId("spLbl").textContent=e.speed.toFixed(1)+"x"),"number"==typeof e.lStart&&(lStart=Number(e.lStart)),"number"==typeof e.lEnd&&(lEnd=Number(e.lEnd)),lEnd||!vid.duration||isNaN(vid.duration)||(lEnd=vid.duration),clampLoop(),updMarks(),"number"==typeof e.curTime&&!isNaN(e.curTime))try{vid.currentTime=e.curTime}catch(e){}e.paused?vid.pause():vid.play().catch((()=>{})),updPrev(),gId("saveP").style.display="inline-block",gId("expGif").style.display="inline-block"}function addPreset(e){const t=gId("url").value.trim(),n={name:gId("pname")?.value||"",...t&&!t.startsWith("blob:")?{url:t}:{},crop:{...crop},mute:vid.muted,speed:vid.playbackRate,curTime:vid.paused?vid.currentTime:void 0,paused:vid.paused,lStart:lStart,lEnd:lEnd,bt:gId("bt").value,br:gId("br").value,gm:gId("gm").value,bg:gId("bg").value};e.push(n)}function clampLoop(){vid.duration&&!isNaN(vid.duration)&&(("number"!=typeof lStart||lStart<0)&&(lStart=0),(!lEnd||lEnd>vid.duration)&&(lEnd=vid.duration),lStart>=lEnd&&(lStart=Math.max(0,lEnd-.1)))}function updMarks(){if(clampLoop(),!vid.duration||isNaN(vid.duration))return lSt.style.display="none",lEd.style.display="none",void(lRegn.style.display="none");lSt.style.display="",lEd.style.display="",lRegn.style.display="";const e=lStart/vid.duration*100,t=lEnd/vid.duration*100;setMarkPos(lSt,e),setMarkPos(lEd,t),setRegnPos(e,t)}function setMarkPos(e,t){e.style.left=t+"%"}function setRegnPos(e,t){lRegn.style.left=e+"%",lRegn.style.width=t-e+"%"}function cxToPct(e){const t=pWrap.getBoundingClientRect();let n=e-t.left;return n=Math.max(0,Math.min(t.width,n)),n/t.width*100}function onMarkDown(e,t){e.preventDefault(),e.stopPropagation(),mDrag=t,e.pointerId&&e.target.setPointerCapture(e.pointerId)}function onDocMove(e){if(!mDrag)return;e.preventDefault();const t=cxToPct(e.clientX);if(!vid.duration||isNaN(vid.duration))return;const n=t/100*vid.duration;"start"===mDrag?lStart=Math.min(n,(lEnd||vid.duration)-.01):lEnd=Math.max(n,(lStart||0)+.01),clampLoop(),updMarks()}function onDocUp(e){if(mDrag){try{if(e.pointerId){("start"===mDrag?lSt:lEd).releasePointerCapture(e.pointerId)}}catch(e){}if(mDrag=null,clampLoop(),updMarks(),!vid.paused&&(vid.currentTime<lStart||vid.currentTime>lEnd))try{vid.currentTime=lStart}catch(e){}}}gId("bg").oninput=()=>{buildLUT()},gId("bt").oninput=()=>{gId("btVal").textContent=gId("bt").value,buildLUT()},gId("br").oninput=()=>{gId("brVal").textContent=gId("br").value,buildLUT()},gId("mAsp").onclick=e=>{e.preventDefault();const t=mw/mh;crop.h=crop.w/t,clampCrop()},gId("mSize").onclick=e=>{if(e.preventDefault(),!vInp)return;const t=vRect.w/dsCvs.width;crop.w=mw*t,crop.h=mh*t},gId("fSize").onclick=e=>{e.preventDefault(),vInp&&(crop.x=vRect.x,crop.y=vRect.y,crop.w=vRect.w,crop.h=vRect.h,clampCrop())},gId("rCrop").onclick=e=>{e.preventDefault(),vInp&&initCrop()},cvs.addEventListener("mousedown",(e=>{if(!vInp)return;const{x:t,y:n}=getPos(e);e.preventDefault(),startDrag(t,n)}),{passive:!1}),cvs.addEventListener("mousemove",(e=>{if(!vInp)return;const{x:t,y:n}=getPos(e);e.preventDefault(),moveDrag(t,n)}),{passive:!1}),cvs.addEventListener("mouseup",(e=>{e.preventDefault(),endDrag()}),{passive:!1}),cvs.addEventListener("touchstart",(e=>{if(!vInp)return;e.preventDefault();const{x:t,y:n}=getPos(e);startDrag(t,n)}),{passive:!1}),cvs.addEventListener("touchmove",(e=>{if(!vInp)return;e.preventDefault();const{x:t,y:n}=getPos(e);moveDrag(t,n)}),{passive:!1}),cvs.addEventListener("touchend",(e=>{e.preventDefault(),endDrag()}),{passive:!1}),cvs.addEventListener("touchcancel",(e=>{e.preventDefault(),endDrag()}),{passive:!1}),gId("saveP").onclick=()=>{const e=gId("url").value.trim(),t=(e?e.split("/").pop().split("?")[0].replace(/\.[^/.]+$/,""):"local-video").substring(0,32)||"video";gId("pname").value=t,gId("saveDlg").classList.add("active")},gId("saveOk").onclick=()=>{const e=getPresets();addPreset(e),savePresets(e),loadPresets(),msg("Preset saved"),gId("saveDlg").classList.remove("active")},gId("saveCn").onclick=()=>gId("saveDlg").classList.remove("active"),lSt.addEventListener("pointerdown",(e=>onMarkDown(e,"start"))),lEd.addEventListener("pointerdown",(e=>onMarkDown(e,"end"))),document.addEventListener("pointermove",onDocMove,{passive:!1}),document.addEventListener("pointerup",onDocUp,{passive:!1}),document.addEventListener("pointercancel",onDocUp,{passive:!1}),prog.addEventListener("pointerdown",(e=>{if(mDrag||!vid.duration||isNaN(vid.duration))return;const t=cxToPct(e.clientX),n=t/100*vid.duration;vid.currentTime=n,prog.value=t}));let gifBlob,gifName,loopInt=null;function enforceLoop(){if(!vid.duration)return;const e=.033*vid.playbackRate;(vid.currentTime>=lEnd-e||vid.currentTime<lStart)&&(keepSend=!1,vid.currentTime=lStart+1e-4)}function genPal(e,t){const n=new Map;for(let t=0;t<e.length;t+=4){const a=e[t]<<16|e[t+1]<<8|e[t+2];n.set(a,(n.get(a)||0)+1)}let a=[Array.from(n,(([e,t])=>({r:e>>16&255,g:e>>8&255,b:255&e,cnt:t})))];for(;a.length<t&&a.some((e=>e.length>1));){a.sort(((e,t)=>t.length-e.length));const e=a.shift();let t="r",n=0;for(const a of["r","g","b"]){let d=255,o=0;for(const t of e)t[a]<d&&(d=t[a]),t[a]>o&&(o=t[a]);const r=o-d;r>n&&(n=r,t=a)}e.sort(((e,n)=>e[t]-n[t]));const d=e.length>>1;a.push(e.slice(0,d),e.slice(d))}const d=a.map((e=>{const t=e.reduce(((e,t)=>e+t.cnt),0);return Math.round(e.reduce(((e,t)=>e+t.r*t.cnt),0)/t)<<16|Math.round(e.reduce(((e,t)=>e+t.g*t.cnt),0)/t)<<8|Math.round(e.reduce(((e,t)=>e+t.b*t.cnt),0)/t)}));let o=1;for(;o<d.length;)o<<=1;for(let e=d.length;e<o;e++)d[e]=d[d.length-1];const r=new Uint8Array(e.length/4);for(let t=0,n=0;t<e.length;t+=4,n++){let a=e[t],o=e[t+1],i=e[t+2],c=0,s=1e9;for(let e=0;e<d.length;e++){const t=d[e],n=(a-(t>>16&255))**2+(o-(t>>8&255))**2+(i-(255&t))**2;n<s&&(s=n,c=e)}r[n]=c}return{indexed:r,palette:d}}function grid(e){if(e<=320)return{w:e,h:1};let t=[1,e],n=e;for(let a=320;a>=2;a--){const d=Math.ceil(e/a),o=a*d-e;if(o<n&&(t=[a,d],n=o,!n))break}return{w:t[0],h:t[1]}}async function expGif(e,t,n){const a=vid.playbackRate||1,d="number"==typeof lStart&&lEnd&&lEnd>lStart+.001,o=d?lStart:0,r=d?lEnd:vid.duration,i=a/t,c=document.createElement("canvas");c.width=mw,c.height=mh;const s=c.getContext("2d",{willReadFrequently:!0});s.imageSmoothingEnabled=!1;const l=vid.currentTime,p=vid.paused,v=[],u=[];let g=null,m=0;async function h(e){vid.currentTime=e,await new Promise((e=>{const t=()=>{vid.removeEventListener("seeked",t),e()};vid.addEventListener("seeked",t)}));const t=(crop.x-vRect.x)/vRect.w*vid.videoWidth,n=(crop.y-vRect.y)/vRect.h*vid.videoHeight,a=crop.w/vRect.w*vid.videoWidth,d=crop.h/vRect.h*vid.videoHeight;s.fillStyle=gId("bg").value,s.fillRect(0,0,mw,mh),s.drawImage(vid,t,n,a,d,0,0,mw,mh);const o=s.getImageData(0,0,mw,mh);return applyFilt(o,!1),o.data}for(let e=o;e<r;){const t=await h(e);g&&t.every(((e,t)=>e===g[t]))?(m+=.01,e+=.01):(e+=i,v.push(t),g&&u.push(Math.max(1,Math.round(100*m/a))),g=t,m=i)}v.length&&u.push(Math.max(1,Math.round(100*m/a)));const f=grid(mw),y=f.w,w=Math.max(f.h,mh),I=new Uint8Array(v.length*y*w*4);v.forEach(((e,t)=>{const n=t*y*w*4;for(let t=0;t<y*w;t++){const a=4*(t<mw*mh?t:mw*mh-1);I[n+4*t]=e[a],I[n+4*t+1]=e[a+1],I[n+4*t+2]=e[a+2],I[n+4*t+3]=255}}));const{indexed:x,palette:b}=genPal(I,n),C=[],L=new GifWriter(C,y,w,{palette:b,loop:0}),E=y*w;L.addFrame(0,0,y,w,x.subarray(0,E),{delay:u[0],disposal:1});for(let e=1;e<v.length;e++){const t=x.subarray(e*E,(e+1)*E),n=x.subarray((e-1)*E,e*E);let a=y,d=w,o=0,r=0;for(let e=0;e<w;e++)for(let i=0;i<y;i++){const c=e*y+i;t[c]!==n[c]&&(i<a&&(a=i),i>o&&(o=i),e<d&&(d=e),e>r&&(r=e))}if(a>o)L.addFrame(0,0,1,1,new Uint8Array([0]),{delay:u[e],disposal:1,transparent:0});else{const n=o-a+1,i=r-d+1,c=new Uint8Array(n*i);for(let e=0;e<i;e++)for(let o=0;o<n;o++)c[e*n+o]=t[(d+e)*y+(a+o)];L.addFrame(a,d,n,i,c,{delay:u[e],disposal:1})}}L.end();const k=new Blob([new Uint8Array(C)],{type:"image/gif"}),R=u.reduce(((e,t)=>e+t),0)/100;try{vid.currentTime=l}catch(e){}return p||vid.play().catch((()=>{})),{blob:k,name:e,frames:v.length,duration:R}}vid.addEventListener("play",(()=>{loopInt&&clearInterval(loopInt),loopInt=setInterval(enforceLoop,16)})),vid.addEventListener("pause",(()=>{loopInt&&(clearInterval(loopInt),loopInt=null)})),vid.addEventListener("timeupdate",enforceLoop),vid.addEventListener("seeked",(()=>keepSend=!0)),gId("expGif").onclick=()=>{if(!vInp)return void msg("No video loaded","error");if(!vid.duration||isNaN(vid.duration))return void msg("Video metadata not ready","error");const e=!vid.paused;e&&vid.pause(),gId("gname").value="myvideo",gId("gfps").value=20,gId("cdepth").value=8,gId("colLbl").textContent="256",gId("expDlg").classList.add("active");const t=gId("expOk"),n=gId("expCn");t.onclick=async()=>{gId("expDlg").classList.remove("active"),ovShow();try{const e=await expGif(gId("gname").value.trim()||"mygif",+gId("gfps").value,1<<+gId("cdepth").value);ovHide(),gifBlob=e.blob,gifName=e.name,gId("gifInf").textContent=`${(e.blob.size/1024).toFixed(1)} KB | ${e.frames} frames | ${e.duration.toFixed(2)}s`;const t=gId("gifPrv"),n=URL.createObjectURL(gifBlob),a=new Image;a.src=n,a.onload=()=>{const e=.9*window.innerWidth,d=.6*window.innerHeight,o=Math.min(e/a.width,d/a.height,8);t.style.width=a.width*o+"px",t.style.height=a.height*o+"px",t.src=n,t.style.display="block"},t.onload=()=>URL.revokeObjectURL(t.src),gId("resDlg").classList.add("active")}catch(t){ovHide(),msg("Export failed: "+t.message,"error"),e&&vid.play().catch((()=>{}))}},n.onclick=()=>{gId("expDlg").classList.remove("active"),e&&vid.play().catch((()=>{}))}},gId("gifDl").onclick=()=>{const e=URL.createObjectURL(gifBlob),t=document.createElement("a");t.href=e,t.download=gifName+".gif",t.click(),URL.revokeObjectURL(e),gId("gifPrv").style.display="none",gId("resDlg").classList.remove("active")},gId("gifUp").onclick=async()=>{try{const e=new FormData;e.append("file",gifBlob,gifName+".gif");(await fetch(`${wu}/upload`,{method:"POST",body:e})).ok?(gId("gifPrv").style.display="none",msg("Uploaded"),gId("resDlg").classList.remove("active")):msg("Upload failed","error")}catch(e){msg("Upload failed","error")}},gId("gifCn").onclick=()=>{gId("gifPrv").style.display="none",gId("resDlg").classList.remove("active")}</script>